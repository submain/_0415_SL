<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>用户管理</title>
    <script src="../jquery/jquery.js"></script>
    <link rel="stylesheet" href="../layui/css/layui.css">
    <style>
        .layui-table {
            width: 1226px;
            border: 1px red solid;
            margin: 0 auto;
            text-align: center;
        }

        .title {
            width: 1226px;
            height: 30px;
            margin: 0 auto;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
        }

        .layui-input-block {
            width: 80px;
        }

        .middle {
            width: 1226px;
            margin: 0 auto;

        }

        #test1 {

        }

        .pageContent {
            margin: 0 auto;
            width: 1226px;
            text-align: center;
        }

        .middle span {
            width: 50px;
            height: 30px;
            background-color: #01AAED;
            display: inline-block;
            text-align: center;
            line-height: 30px;
            cursor: pointer;
        }

        .layui-form-item {
            display: inline-block;
        }

        #addframe {
            width: 600px;
            /*height: 600px;*/
            /*border: 1px red solid;*/
        }

        .layui-input-block{
            width: 150px;
        }

    </style>
</head>
<body>
<div class="title">
    <p>用户管理</p>
</div>
<div class="middle">
    <span id="add">新增</span>
    <span>修改</span>
    <span id="delete">删除</span>
    <input type="text" placeholder="请输入关键词查找" style="height: 30px;">
    <div style="width: 60px;height: 30px;background-color: #b2b2b2;display: inline-block;margin-top: -10px;text-align: center;line-height: 30px;cursor: pointer">
        查找
    </div>
</div>

<table class="layui-table">
    <thead style="text-align: center;font-weight: bold;">
    <tr>
        <td style="background-color: #01AAED">选择</td>
        <td style="background-color: #01AAED">用户名</td>
        <td style="background-color: #01AAED">角色</td>
        <td style="background-color: #01AAED">会员类型</td>
        <td style="background-color: #01AAED">推荐人用户名</td>
        <td style="background-color: #01AAED">状态（启用/禁用）</td>
        <td style="background-color: #01AAED">最后修改时间</td>
    </tr>
    </thead>
    <tbody class="my_t_body" id="my_t_body">
    <tr>
        <td><a href="">东城区</a></td>
        <td>2016-11-29</td>
        <td>人生就像是一场修行</td>
        <td>贤心</td>
        <td>2016-11-29</td>
        <td>人生就像是一场修行</td>
        <td>人生就像是一场修行</td>
    </tr>
    <tr>
        <td>许闲心</td>
        <td>2016-11-28</td>
        <td>于千万人之中遇见你</td>
        <td>许闲心</td>
        <td>2016-11-28</td>
        <td>于千万人之中遇见你</td>
        <td>于千万人之中遇见你</td>
    </tr>

    </tbody>
</table>
<div class="pageContent">
    <div id="test1"></div>
</div>
<div id="addframe" style="display: none">
    <form action="" class="layui-form" id="form1" >
        <div class="layui-form-item">
            <label class="layui-form-label">角色</label>
            <div class="layui-input-block">
                <select name="role" lay-verify="required" id="role">
                    <option value=""></option>
                    <option value="0">会员</option>
                    <option value="1">管理员</option>
                </select>
            </div>

        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">会员类型</label>
            <div class="layui-input-block">
                <select name="viptype" lay-verify="required" id="viptype">
                    <option value=""></option>
                    <option value="0">注册会员</option>
                    <option value="1">消费会员</option>
                    <option value="2">vip会员</option>
                    <option value="3">加盟店</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-block">
                <input type="text" name="username" id="username" required  lay-verify="required" placeholder="请输入标题" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input type="text" name="name" id="name" required  lay-verify="required" placeholder="请输入姓名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">证件类型</label>
            <div class="layui-input-block">
                <select name="cardtype" lay-verify="required" id="cardtype">
                    <option value=""></option>
                    <option value="0">二代身份证</option>
                    <option value="1">护照</option>
                    <option value="2">军证官</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">证件号码</label>
            <div class="layui-input-block">
                <input type="text" name="cardnum" id="cardnum" required  lay-verify="required" placeholder="请输入姓名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">移动电话</label>
            <div class="layui-input-block">
                <input type="text" name="phonenum" id="phonenum" required  lay-verify="required" placeholder="请输入姓名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮政编码</label>
            <div class="layui-input-block">
                <input type="text" name="email" id="email" required  lay-verify="required" placeholder="请输入姓名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">收货地址</label>
            <div class="layui-input-block">
                <textarea name="addr" id="addr" placeholder="请输入内容" class="layui-textarea" style="width: 413px"></textarea>
            </div>
        </div>

        <button type="button" class="layui-btn" id="test3" style="margin-top:130px;margin-left:-150px">
            <i class="layui-icon">&#xe67c;</i>上传身份证图片
        </button>
        <div class="layui-upload-list" style="display:inline-block">
            <img id="demo1" width="50px" height="50px" style="margin-top: 128px">
        </div>
        <div>
        <button type="button" class="layui-btn" id="test4" style="margin-top:30px;margin-left: 115px;">
            <i class="layui-icon">&#xe67c;</i>上传银行卡图片
        </button>
        <div class="layui-upload-list" style="display: inline-block">
            <img id="demo2" width="50px" height="50px" style="margin-top: 28px">
        </div>
        </div>

        <div class="layui-form-item" style="margin-left: 200px">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="formDemo" style="margin-top: 30px;display: inline-block;margin-left: -10px" id="Lsubmit">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary" style="margin-top: 30px;display: inline-block;margin-left: -3px">重置</button>
            </div>
        </div>
    </form>
</div>


</body>
<script src="../layui/layui.all.js"></script>
<script>

    var pageSize = 2
    var page = 1
    var areaNum = 0;
    var newUserId=0;
    //图片地址1
    var imgaddr1 = 0;
    //图片地址2
    var imgaddr2 = 0;

    //获取下拉选框的值

    layui.use('upload', function(){
        var upload = layui.upload;

        //执行实例上传身份证正反面
        var uploadInst = upload.render({
            elem: '#test3'
            , url: 'identityCardload'
            , auto: true

            , acceptMime: 'image/*'
            , choose: function (obj) {
                //预读本地文件示例，不支持ie8
                obj.preview(function (index, file, result) {
                    $('#demo1').attr('src', result); //图片链接（base64）
                });
            }
            , done: function (res) {
                if (res.success == 1) {
                    imgaddr1=res.data
                    console.log(res)
                    layer.msg("上传成功！")
                   // updateDataBaseHeadImg(userID, res.data)
                   //  setTimeout(function () {
                   //      layer.closeAll();
                   //  }, 1000);
                }
            }
            , error: function () {
                //console.log(arguments)
            }
        });
        //执行实例上传银行卡图片
        var uploadInst = upload.render({
            elem: '#test4'
            , url: 'identityCardload1'
            , auto: true
            , acceptMime: 'image/*'
            , choose: function (obj) {
                //预读本地文件示例，不支持ie8
                obj.preview(function (index, file, result) {
                    $('#demo2').attr('src', result); //图片链接（base64）
                });
            }
            , done: function (res) {
                imgaddr2=res.data
                if (res.success == 1) {
                    layer.msg("上传成功！")
                   // updateDataBaseHeadImg(userID, res.data)
                   //  setTimeout(function () {
                   //      layer.closeAll();
                   //  }, 1000);
                }
            }
            , error: function () {
                //console.log(arguments)
            }
        });
    });


    $("#search").click(function () {
        // alert($("#select_area").val())
        areaNum = $("#select_area").val()
        ajaxGetAirQuiltyByPage()
    })

    layui.use('form', function () {
        var form = layui.form;

        //各种基于事件的操作，下面会有进一步介绍
    });

    function renderPageContainer(count) {
        layui.use('laypage', function () {
            var laypage = layui.laypage;

            //执行一个laypage实例
            laypage.render({
                elem: 'test1' //注意，这里的 test1 是 ID，不用加 # 号
                , count: count //数据总数，从服务端得到
                , limit: pageSize
                , curr: page
                , limits: [2, 4]
                , layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']
                , jump: function (obj, first) {
                    //obj包含了当前分页的所有参数，比如：
                    console.log(obj.curr); //得到当前页，以便向服务端请求对应页的数据。
                    console.log(obj.limit); //得到每页显示的条数

                    //首次不执行
                    if (!first) {

                        //把分页值，和分页量（分页量可能会变化）
                        page = obj.curr;
                        pageSize = obj.limit;

                        ajaxGetAirQuiltyByPage()
                    }
                }
            });
        });
    }

    ajaxGetAirQuiltyByPage()

    function ajaxGetAirQuiltyByPage() {

        $.ajax({
            url: "getUserList",
            data: {"page": page, "pageSize": pageSize},
            datatype: "json",
            type: "get",
            success: function (json) {
                console.log(json)
                renderPageContainer(json.count)
                renderAjaxTable(json.data)
                if (json.success == 404) {
                    $("#my_t_body").html("")
                    var html = `
             <tr>
                    <td colspan="6">抱歉！暂无数据</td>

                </tr>`
                    $("#my_t_body").append(html)
                }
            },
            error: function () {

            }
        })
    }

    //渲染数据
    function renderAjaxTable(data) {
        $("#my_t_body").html("")
        $.each(data, function (index, eachobj) {
            if (index % 2 == 0) {
                if (eachobj.isStart == 1) {
                    var html = `<tr>
        <td><input type="checkbox" userid="${eachobj.id}" class="isChoicea"></td>
        <td>${eachobj.userName}</td>
        <td>${eachobj.roleName}</td>
        <td>${eachobj.userTypeName}</td>
        <td>${eachobj.referCode}</td>
        <td><input type="checkbox" id="${eachobj.id}" checked class="status"></td>
        <td>${eachobj.lastUpdateTime}</td>

    </tr>`
                    $("#my_t_body").append(html)
                    $(".status").click(function () {
                        var id = $(this).attr("id")
                        if ($(this).is(':checked')) {


                            var status = 1
                            alert(status)
                            console.log(status)
                            madifyUserStatus(status, id)

                        } else {

                            var status = 0
                            console.log(status)
                            madifyUserStatus(status, id)

                        }

                    })
                } else {
                    var html = `<tr>
         <td><input type="checkbox" userid="${eachobj.id}"  class="isChoicea"></td>
        <td>${eachobj.userName}</td>
        <td>${eachobj.roleName}</td>
        <td>${eachobj.userTypeName}</td>
        <td>${eachobj.referCode}</td>
        <td><input type="checkbox" id="${eachobj.id}" class="status"></td>
        <td>${eachobj.lastUpdateTime}</td>

    </tr>`
                    $("#my_t_body").append(html)
                    $(".status").click(function () {
                        var id = $(this).attr("id")
                        if ($(this).is(':checked')) {
                            var status = 1
                            madifyUserStatus(status, id)
                        } else {
                            var status = 0

                            madifyUserStatus(status, id)
                        }

                    })
                }

            } else {
                if (eachobj.isStart == 1) {
                    var html = `<tr>
        <td style="background-color: #9FDEAD"><input type="checkbox" userid="${eachobj.id}"  class="isChoicea"></td>
        <td style="background-color: #9FDEAD">${eachobj.userName}</td>
        <td style="background-color: #9FDEAD">${eachobj.roleName}</td>
        <td style="background-color: #9FDEAD">${eachobj.userTypeName}</td>
        <td style="background-color: #9FDEAD">${eachobj.referCode}</td>
        <td style="background-color: #9FDEAD"><input type="checkbox" id="${eachobj.id}" checked class="status"></td>
        <td style="background-color: #9FDEAD">${eachobj.lastUpdateTime}</td>
    </tr>`
                    $("#my_t_body").append(html)
                    $(".status").click(function () {
                        var id = $(this).attr("id")
                        if ($(this).is(':checked')) {
                            var status = 1
                            madifyUserStatus(status, id)
                        } else {
                            var status = 0
                            madifyUserStatus(status, id)

                        }

                    })
                } else {
                    var html = `<tr>
        <td style="background-color: #9FDEAD"><input type="checkbox" userid="${eachobj.id}" class="isChoicea"></td>
        <td style="background-color: #9FDEAD">${eachobj.userName}</td>
        <td style="background-color: #9FDEAD">${eachobj.roleName}</td>
        <td style="background-color: #9FDEAD">${eachobj.userTypeName}</td>
        <td style="background-color: #9FDEAD">${eachobj.referCode}</td>
        <td style="background-color: #9FDEAD"><input type="checkbox" id="${eachobj.id}" class="status"></td>
        <td style="background-color: #9FDEAD">${eachobj.lastUpdateTime}</td>
    </tr>`
                    $("#my_t_body").append(html)
                    $(".status").click(function () {
                        var id = $(this).attr("id")
                        if ($(this).is(':checked')) {
                            var status = 1
                            madifyUserStatus(status, id)
                        } else {
                            var status = 0
                            madifyUserStatus(status, id)
                        }

                    })
                }
            }
        })

    }

    //修改用户状态
    function madifyUserStatus(status, id) {
        $.ajax({
            url: "madifyUserStatus",
            data: {"status": status, "id": id},
            datatype: "json",
            type: "get",
            success: function (json) { // console.log(json)

            },
            error: function () {

            }
        })
    }

    //增加
    layui.use(['layer','form'], function () {
        var layer = layui.layer;
        var form = layui.form;
        //增加
        $("#add").click(function () {
            layer.open({
                type: 1,
                area: ['600px', '600px'],
                content: $('#addframe'), //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                cancel: function(index, layero){
                    if(confirm('确定要关闭么')){ //只有当点击confirm框的确定时，该层才会关闭
                        layer.close(index)
                        $("#addframe").css("display","none")
                    }
                    return false;
                }
            })

            //正则
            form.verify({
                nickname: function (value) { //value：表单的值、item：表单的DOM对象
                    if (value) {
                        if (!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)) {
                            return '昵称不能有特殊字符';
                        }
                        if (/(^\_)|(\__)|(\_+$)/.test(value)) {
                            return '昵称首尾不能出现下划线\'_\'';
                        }
                    }

                }
            });
            form.render()
            form.on('submit(formDemo)', function (data) {
                var cardType = $("#cardtype").val()
                var cardTypeName=0
                if (cardType==0){
                    cardTypeName="二代身份证"
                }else if (cardType==1) {
                    cardTypeName="护照";
                }else if (cardType==2){
                    cardTypeName="军证官"
                }
                var roleId = $("#role").val()
                var roleName = 0;
                if (roleId==0){
                    roleName="会员"
                }else if (roleId==1) {
                    roleName="管理员";
                }
                var userType = $("#viptype").val()
                var userTypeName = 0;
                if (userType==0){
                    userTypeName="注册会员"
                }else if (userType==1) {
                    userTypeName="消费会员";
                }else if (userType==2){
                    userTypeName="VIP会员"
                }else if (userType==3){
                    userTypeName="加盟店"
                }
                var userName = $("#username").val()
                var userAddress=$("#addr").val()
                var postCode = $("#cardnum").val()
                var  email=$("#email").val()
                var mobile=$("#phonenum").val()
                //console.log(data.elem) //被执行事件的元素DOM对象，一般为button对象
                // console.log(data.form) //被执行提交的form对象，一般在存在form标签时才会返回
                alert(userAddress) //当前容器的全部表单字段，名值对形式：{name: value}
                $.ajax({
                    type: "get",//方法
                    url: "addUser",//表单接收url
                    data:{"userName":userName,"userAddress":userAddress,
                        "postCode":postCode,"email":email,"moble":mobile,
                        "cardType":cardType,"cardTypeName":cardTypeName,
                        "roleId":roleId,"roleName":roleName,
                        "userType":userType,"userTypeName":userTypeName,
                        "idCardPicPath":imgaddr1,"bankPicPath":imgaddr2},
                    async: false,
                    success: function (josnData) {
                        if (josnData.success == 1) {
                            layer.msg("修改成功")
                        } else {
                            layer.msg("修改失败")
                        }
                    },
                    error: function () {
                    }
                });
                setTimeout(function () {
                    layer.closeAll();
                    window.location.href = window.location.href
                }, 500);
                关闭信息框
                return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
            });


        })
        //修改

    });
    //修改身份证图片事件(更新数据库)
    function modifyidentityCardimg( headImg) {

        $.ajax({
            url: "modifyidentityCardimg"
            , data: {"userId": userId, "headImg": headImg}
            , type: "post"
            , dataType: "json"
            , success: function (jsonData) {
                // console.log(jsonData)
            }
            , error: function (res) {
                console.log("ajax提交错误")
            }
        })
    }

    //删除按钮
    $("#delete").click(function () {
        $(".isChoicea").each(function () {
            var id = $(this).attr("userid")
            if ($(this).is(':checked')) {
                $.ajax({
                    url:"deleteUser",
                    data: {"id": id},
                    datatype: "json",
                    type: "get",
                    success: function (json) {
                        console.log(json)
                    },
                    error: function () {

                    }
                })
            }

        })
        alert("删除成功")
        location.href=location.href
    })




</script>
</html>